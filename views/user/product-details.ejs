<%- include("../partials/header") %>

    <!--breadcrumbs area start-->
    <div class="breadcrumbs_area product_bread">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="breadcrumb_content">
                        <ul>
                            <li><a href="/">home</a></li>
                            <li>/</li>
                            <li>product details</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--breadcrumbs area end-->

    <!--product details start-->
    <div class="product_details">
        <div class="container">
            <div class="row">
                <div class="col-lg-5 col-md-5">
                    <div class="product-details-tab">

                        <div id="img-1" class="zoomWrapper single-zoom">
                            <a href="#">
                                <img id="zoom1" src="/uploads/product-images/<%= data.productImage[0] %>"
                                    data-zoom-image="/uploads/product-images/<%= data.productImage[0] %>" alt="big-1">
                            </a>
                        </div>

                        <div class="single-zoom-thumb">
                            <ul class="s-tab-zoom owl-carousel single-product-active" id="gallery_01">
                                <% for (let j=0; j < data.productImage.length; j++) { %>
                                    <li>
                                        <a href="#" class="elevatezoom-gallery active" data-update=""
                                            data-image="/uploads/product-images/<%= data.productImage[j] %>"
                                            data-zoom-image="/uploads/product-images/<%= data.productImage[j] %>">
                                            <img src="/uploads/product-images/<%= data.productImage[j] %>"
                                                alt="zo-th-1" />
                                        </a>

                                    </li>

                                    <% } %>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7 col-md-7">
                    <div class="product_d_right">
                        <form method="POST" action="/addToCart">

                            <h1>
                                <%= data.productName %>
                            </h1>
                            <div class=" product_ratting">
                                <ul>
                                    <li><a href="#"><i class="fa fa-star"></i></a></li>
                                    <li><a href="#"><i class="fa fa-star"></i></a></li>
                                    <li><a href="#"><i class="fa fa-star"></i></a></li>
                                    <li><a href="#"><i class="fa fa-star"></i></a></li>
                                    <li><a href="#"><i class="fa fa-star"></i></a></li>
                                    <li class="review"><a href="#"> 1 review </a></li>
                                    <li class="review"><a href="#"> Write a review </a></li>
                                </ul>
                            </div>
                            <div class="product_price">
                                <span class="current_price">â‚¹<%= data.salePrice.toFixed(2) %></span>
                            </div>
                            <div class="product_desc">
                                <p>
                                    <%= data.productDescription %>
                                </p>
                            </div>

                            <div class="product_variant size">
                                <h3>size</h3>
                                <select class="niceselect_option" id="color1" name="produc_color">
                                    <option selected value="1">size</option>
                                    <option value="Small">Small</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Large">Large</option>
                                </select>
                            </div>
                            <div class="product_variant quantity">
                                <label for="quantity">Quantity</label>
                                <input id="quantity" name="quantity" min="1" max="5" value="1" type="number">
                                <button type="button" class="button" onclick="addToCart('<%= data._id %>')">Add to
                                    Cart</button>
                            </div>
                            <div class="product_stock">
                                <% let outOfStock=false; %>
                                    <% data.productSizes.forEach(size=> { %>
                                        <% console.log('Size:', size.size, 'Quantity:' , size.quantity); %>
                                            <% if (size.quantity <=0) { %>
                                                <span class="out_of_stock">Out of Stock: <%= size.size %></span>
                                                <% outOfStock=true; %>
                                                    <% } else { %>
                                                        <span class="stock_amount">
                                                            <%= size.size %>: <%= size.quantity %> left
                                                        </span>
                                                        <% } %>
                                                            <% }); %>
                                                                <% if (!outOfStock) { %>
                                                                    <span class="stock_amount">In Stock</span>
                                                                    <% } %>
                            </div>



                            <div class="product_d_action">
                                <ul>
                                    <!-- Modified anchor tag to include product ID and size in the URL -->
                                    <li><a href="#" onclick="addToWishlist(event, '<%= data._id %>')"
                                            title="Add to wishlist">
                                            <i class="fa fa-heart-o" aria-hidden="true"></i> Add to Wish List</a></li>
                                </ul>
                            </div>


                        </form>


                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--product details end-->


    <!--product section area start-->
    <section class="product_section related_product">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="section_title">
                        <h2>Related Products</h2>
                        <p>"Unlock more possibilities with these complementary products tailored to enhance your
                            experience."</p>
                    </div>
                </div>
            </div>
            <div class="product_area">
                <div class="row">
                    <div class="product_carousel product_three_column4 owl-carousel">
                        <% for (let i=0; i < products.length; i++) { %>
                            <div class="col-lg-3">
                                <div class="single_product">
                                    <div class="product_thumb">
                                        <a class="primary_img" href="/productDetails/<%= products[i]._id %>"><img
                                                src="/uploads/product-images/<%= products[i].productImage[0] %>"
                                                alt=""></a>
                                        <a class="secondary_img" href="/productDetails/<%= products[i]._id %>"><img
                                                src="/uploads/product-images/<%= products[i].productImage[1] %>"
                                                alt=""></a>
                                        <div class="product_action">
                                            <div class="hover_action">
                                                <a href="#"><i class="fa fa-plus"></i></a>
                                                <div class="action_button">
                                                    <ul>

                                                        <li><a title="add to cart" href="cart.html"><i
                                                                    class="fa fa-shopping-basket"
                                                                    aria-hidden="true"></i></a></li>
                                                        <li><a href="wishlist.html" title="Add to Wishlist"><i
                                                                    class="fa fa-heart-o" aria-hidden="true"></i></a>
                                                        </li>

                                                        <li><a href="compare.html" title="Add to Compare"><i
                                                                    class="fa fa-sliders" aria-hidden="true"></i></a>
                                                        </li>

                                                    </ul>
                                                </div>
                                            </div>

                                        </div>

                                        <% let priceDifference=products[i].regularPrice - products[i].salePrice; %>
                                            <% if (priceDifference> 0) { %>
                                                <div class="product_sale">
                                                    <span>â‚¹<%= priceDifference %> off</span>
                                                </div>
                                                <% } %>
                                    </div>
                                    <div class="product_content">
                                        <h3><a href="/productDetails/:id">
                                                <%= products[i].productName %>
                                            </a></h3>
                                        <span class="current_price">â‚¹<%= products[i].salePrice.toFixed(2) %></span>
                                        <span class="old_price">â‚¹<%= products[i].regularPrice.toFixed(2) %></span>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                    </div>
                </div>
            </div>

        </div>
    </section>
    <!--product section area end-->

    <%- include("../partials/footer") %>



        <script>

            document.addEventListener('DOMContentLoaded', function () {
                const sizeSelect = document.getElementById('color1');
                const quantityInput = document.getElementById('quantity');
                const productStock = document.querySelector('.product_stock');

                console.log('sizeSelect:', sizeSelect);
                console.log('quantityInput:', quantityInput);
                console.log('productStock:', productStock);
                let lastSelectedQuantity;
                sizeSelect.addEventListener('change', handleStockChange);
                quantityInput.addEventListener('input', handleStockChange);

                function handleStockChange() {
                    console.log('handleStockChange called');
                    const selectedSize = sizeSelect.value;
                    const quantity = quantityInput.value;
                    const outOfStock = Array.from(productStock.querySelectorAll('.out_of_stock')).some(span => span.textContent.includes(selectedSize));

                    if (outOfStock) {
                        showToastNotification('error', `The selected size (${selectedSize}) is out of stock.`);
                        quantityInput.disabled = true;
                        setTimeout(function () {
                            window.location.reload();
                        }, 2000);
                    } else {
                        quantityInput.disabled = false;
                        // lastSelectedQuantity = quantity;
                        sendStockRequest('<%= data._id %>', selectedSize, quantity);
                    }
                }

                function sendStockRequest(productId, size, quantity) {

                    fetch('/get-stock-status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ productId, size, quantity })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showToastNotification('success', 'product quantity updated.');
                            } else {
                                showToastNotification('error', data.message);
                                quantityInput.disabled = true;
                                setTimeout(function () {
                                    window.location.reload();
                                }, 2000);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showToastNotification('error', 'An error occurred while checking stock.');
                            // quantityInput.value = lastSelectedQuantity;
                        });
                }

                function showToastNotification(type, message) {
                    Toastify({
                        text: message,
                        duration: 3000,
                        gravity: 'top',
                        position: 'center',
                        backgroundColor: type === 'success' ? '#4CAF50' : '#ff6347',
                    }).showToast();
                }
            });


            function addToCart(prodId) {
                console.log("Adding product to cart...");
                console.log(prodId);

                // Fetch the quantity from the user input
                var quantity = $('#quantity').val();

                // Assuming your input field has id="quantity"

                var size = $('#color1').val();

                // Log both quantity and size
                console.log("Quantity:", quantity);
                console.log("Size:", size);

                if (size === "1") {
                    Toastify({
                        text: "Please select a size.",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #ff6c6c, #f66262)",
                    }).showToast();
                    return; // Exit the function if the quantity exceeds the limit
                }

                $.ajax({
                    url: `/addToCart/${prodId}/${quantity}/${size}`,
                    method: 'POST',
                    success: (res) => {
                        // Log the response object
                        if (res.status === "true") {
                            Toastify({
                                text: "Added to Cart!",
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "center",
                                backgroundColor: "linear-gradient(to right, #4bb543, #98ec2d)",
                            }).showToast();
                            setTimeout(() => {
                                window.location.href = '/cart';
                            }, 3000);
                        } else if (res.status === "Out of stock") {
                            Toastify({
                                text: "The product is out of stock",
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "center",
                                backgroundColor: "linear-gradient(to right, #ff6c6c, #f66262)",
                            }).showToast();
                        } else {
                            Toastify({
                                text: "You need to Login first",
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "center",
                                backgroundColor: "linear-gradient(to right, #ff6c6c, #f66262)",
                            }).showToast();
                            setTimeout(() => {
                                window.location.href = '/login';
                            }, 3000);
                        }
                    },
                    error: (xhr, status, error) => {
                        console.error('Error:', error);
                        Toastify({
                            text: "An error occurred while processing your request. Please try again later.",
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "linear-gradient(to right, #ff6c6c, #f66262)",
                        }).showToast();
                    }
                });
            }


            function addToWishlist(event, productId) {
                event.preventDefault();
                var size = $('#color1').val();
                if (size === "1") {
                    Toastify({
                        text: "Please select a size.",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #ff6c6c, #f66262)",
                    }).showToast();
                    return; // Exit the function if the quantity exceeds the limit
                }

                fetch(`/addToWishlist/${productId}/${size}`, {
                    method: 'POST'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to add item to wishlist');
                        }
                        $('.fa-heart-o').addClass('red-heart');

                        // If response is OK, show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: 'Item added to wishlist successfully'
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // If error occurs, show error message
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to add item to wishlist. Please try again later.'
                        });
                    });
            }



        </script>