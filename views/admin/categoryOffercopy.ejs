<%- include("../partials/adminHeader") %>

<div class="content-header">
    <div>
        <h2 class="content-title card-title">Category Offer Management</h2>  
    </div>
    <!-- <div style="float: right; margin-right: 10px;">
        <button style="background-color: green; color: white; border: none; padding: 10px 20px; cursor: pointer;">Add Offer</button>
    </div> -->
    <div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCoupon"
            data-bs-whatever="@getbootstrap">Add Offer +</button>
    </div>
</div>

    <div class="right mt-5">
        <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col"><b>No</b></th>
                <th scope="col"><b>Offer Name</b></th>
                <th scope="col"><b>Category</b></th>
                <!-- <th scope="col"><b>Brand</b></th> -->
                <th scope="col"><b>Discount</b></th>
                <th scope="col"><b>Starting Date</b></th>
                <th scope="col"><b>Ending Date</b></th>
                <th scope="col"><b>Delete</b></th>
                <th scope="col"><b>Edit</b></th>
              </tr>
            </thead>
            <tbody>
                <% for(let i = 0; i < offers.length; i++) { %>
                    <tr>
                        <td><%= i + 1 %></td>
                        <td><%= offers[i].name %></td>
                        <td>
                            <%= offers[i].categoryOffer.category.name %>
                        </td>
                        <td><%= offers[i].categoryOffer.discount %> %</td>
                        <td><%= offers[i].startingDate.toLocaleDateString() %></td>
                        <td><%= offers[i].endingDate.toLocaleDateString() %></td>
                        <td width="10%"><a onclick="deleteOffer('<%= catoffers[i]._id %>')"
                            class="btn btn-sm btn-danger rounded font-sm mt-15">Delete</a> </td> 
                            <td>
                                <button type="button" class="btn btn-primary edit-offer-btn" 
                                    style="padding: 5px 10px; font-size: 12px;" 
                                    data-bs-toggle="modal" data-bs-target="#editCoupon" data-bs-whatever="@getbootstrap"
                                    data-offer-id="<%= catoffers[i]._id %>"
                                    data-offer-name="<%= catoffers[i].name %>"
                                    data-product-name="<%= catoffers[i].categoryOffer.category.name %>"
                                    data-discount="<%= catoffers[i].discount %>"
                                    data-start-date="<%= catoffers[i].startingDate %>"
                                    data-end-date="<%= catoffers[i].endingDate %>"
                                >
                                    Edit Offer +
                                </button>
                            </td>
                      
                    </tr>
                <% } %>
            </tbody>
            
          </table>
    </div>

        
    </div> <!-- card-body end// -->
</div> <!-- card end// -->

<!-- Modal Add Coupon -->

<div class="modal fade" id="addCoupon" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add Offer </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form action="/admin/add-catOffer" method="post" id="catOffer">
                  <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Offer Name</label>
                      <input type="text" class="form-control" name="name" id="couponName" >
                      <div id="error1" class="text-danger"></div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="recipient-name" class="col-form-label">Category</label>
                    <select name="category" id="couponName" class="form-select">
                      <% for( let i = 0; i < categories.length; i++ ) { %>
                      <option class="form-option" value="<%= categories[i]._id %>"><%= categories[i].name %></option>
                      <% } %>
                    </select>
                    <!-- <input type="text" class="form-control" name="couponName" id="couponName"> -->
                  </div>
                  <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Discount</label>
                      <input type="text" class="form-control" name="discount" id="couponAmount">
                      <div id="error2" class="text-danger"></div>
                  </div>
                  <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Starting date</label>
                      <input type="date" class="form-control" name="startingDate" required="true" id="startingDate">
                  </div>
                  <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Ending date</label>
                      <input type="date" class="form-control" name="endingDate" required="true" id="expiringDate">
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="submit" class="btn btn-primary">Create Offer</button>
                  </div>

              </form>
          </div>

      </div>
  </div>
</div>


<!--End Modal  Add Coupon-->

<!-- Modal Edit Coupon -->

<div class="modal fade" id="editCoupon" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Edit Offer </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form action="/admin/edit-catOffer" method="post" id="editCatOffer">
                  <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Offer Name</label>
                      <input type="text" class="form-control" name="name" id="offerName">
                      <div id="error3" class="text-danger"></div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="recipient-name" class="col-form-label">Category</label>
                    <select name="category" id="category" class="form-select">
                      <% for( let i = 0; i < categories.length; i++ ) { %>
                        <option class="form-option" value="<%= categories[i]._id %>"><%= categories[i].name %></option>
                        <% } %>
                    </select>
                    
                  </div>
                  <!-- <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Coupon Code</label>
                      <input type="text" class="form-control" name="couponCode" id="couponCode">
                  </div> -->
                  <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Discount</label>
                      <input type="text" class="form-control" name="discount" id="discount">
                      <div id="error4" class="text-danger"></div>
                  </div>
                  <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Starting Date</label>
                      <input type="date" class="form-control" name="startingDate" id="offerStart">
                  </div>
                  <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Ending Date</label>
                      <input type="date" class="form-control" name="endingDate" id="offerEnd">
                  </div>
                  <div class="mb-3">
                      <input type="hidden" class="form-control" value="<%= offers._id %>" id="offerIdd" name="offerId" />
                  </div>

                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="submit" class="btn btn-primary">Update Offer</button>
                  </div>

              </form>
          </div>

      </div>
  </div>
</div>



<!--End Modal Edit Coupon-->


<%- include("../partials/adminFooter") %>

<script>

function openEditModal(button) {
    var offerId = button.getAttribute('data-offer-id');
    var offerName = button.getAttribute('data-offer-name');
    var categoryId = button.getAttribute('data-category-id');
    var discount = button.getAttribute('data-discount');
    var startingDate = button.getAttribute('data-starting-date');
    var endingDate = button.getAttribute('data-ending-date');

    // Set the values of the modal inputs based on the retrieved data attributes
    document.getElementById('offerId').value = offerId;
    document.getElementById('offerName').value = offerName;
    document.getElementById('category').value = categoryId;
    document.getElementById('discount').value = discount;
    document.getElementById('offerStart').value = startingDate;
    document.getElementById('offerEnd').value = endingDate;

    // Open the edit modal
    var editModal = new bootstrap.Modal(document.getElementById('editCoupon'));
    editModal.show();
}

// Attach click event listener to all buttons with the "edit-offer-btn" class
var editOfferButtons = document.querySelectorAll('.edit-offer-btn');
editOfferButtons.forEach(function(button) {
    button.addEventListener('click', function() {
        openEditModal(this);
    });
});



  function deleteOffer(offerId) {
    console.log("clicked", offerId);
    Swal.fire({
        title: 'Are you sure you want to delete this offer?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'No, cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "/admin/delete-catOffer/" + offerId,
                type: 'get',
            }).done((res) => {
                if (res) {
                    Swal.fire(
                        'Successful',
                        'Offer deleted successfully',
                        'success'
                    ).then(() => {
                        location.reload();
                    });
                }
            }).fail((error) => {
                console.log(error);
            });
        }
    });
}
</script>